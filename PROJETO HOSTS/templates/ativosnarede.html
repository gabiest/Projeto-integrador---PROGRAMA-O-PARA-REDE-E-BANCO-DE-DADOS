<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hosts | Inventário de Ativos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <button class="botao-menu"><i class="fa-solid fa-bars"></i></button>

    <nav class="menu-lateral">
        <div class="conta-item"><a href="configuracoes.html"><i class="bi bi-person-circle"></i><b>Conta</b></a></div>
        <ul>
            <li><a href="home.html"><i class="bi bi-house-door-fill"></i><b>Home</b></a></li>
            <li><a href="dashboard.html"><i class="bi bi-graph-up"></i><b>Dashboard</b></a></li>
            <li><a href="ativosonline.html"><i class="bi bi-check-circle-fill"></i><b>Ativos Online</b></a></li>
            <li><a href="ativosnarede.html" class="active"><i class="bi bi-hdd-stack-fill"></i><b>Inventário</b></a></li>
            <li><a href="configuracoes.html"><i class="bi bi-gear-fill"></i><b>Configurações</b></a></li>
        </ul>
        <div class="logout-item"><a href="login/login.html"><i class="bi bi-box-arrow-left"></i><b>Logout</b></a></div>
    </nav>
    
    <div class="background"></div>
    
    <main class="conteudo">
        <div class="page-header"> 
            <h1>Inventário de Ativos</h1>
            <div class="botoes-header">
                <!-- Botão Adicionar chama a função de abrir modal limpo -->
                <button class="btn-add" id="add-asset-btn" onclick="abrirModalCriacao()">
                    <i class="bi bi-plus-circle-fill"></i> Adicionar Novo Ativo
                </button>
                
                <button class="btn-add" id="refresh-btn" type="button" onclick="carregarDadosInventario()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
        </div>
        
        <p>Gerencie todos os dispositivos cadastrados na sua infraestrutura.</p>

        <div class="search-container">
            <i class="bi bi-search"></i>
            <input type="search" id="search-input" placeholder="Pesquisar por nome, ID ou status...">
        </div>

        <div class="table-wrapper">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Nome do Ativo</th>
                        <th>Endereço Mac</th> 
                        <th>Identificador (ID/IP)</th>
                        <th>Status</th>
                        <th>Condição</th>
                        <th>Ações</th> 
                    </tr>
                </thead>
                <tbody id="inventory-table-body">
                    <tr><td colspan="6" style="text-align:center">Iniciando sistema...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Ativo -->
    <div class="modal-overlay" id="asset-modal">
        <div class="modal-content">
            <h2 id="modal-title">Adicionar Novo Ativo</h2>
            <form id="asset-form" onsubmit="salvarAtivo(event)">
                <!-- Input escondido para guardar o ID quando for edição -->
                <input type="hidden" id="assetIdDatabase"> 
                
                <div class="form-group">
                    <label for="assetName">Nome do Ativo</label>
                    <input type="text" id="assetName" required>
                </div>
                <div class="form-group">
                    <label for="macAddress">Endereço MAC</label>
                    <input type="text" id="macAddress" required>
                </div>
                <div class="form-group">
                    <label for="assetId">Identificador (IP)</label>
                    <input type="text" id="assetId" required>
                </div>
                <!-- O campo Tipo não existia na sua tabela do banco, então removi ou deixei opcional -->
                
                <div class="form-group">
                    <label for="assetStatus">Status</label>
                    <select id="assetStatus">
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assetCondition">Condição</label>
                    <select id="assetCondition">
                        <option value="Disponível">Disponível</option>
                        <option value="Alocado">Alocado</option>
                        <option value="Manutenção">Manutenção</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="fecharModais()">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação para Excluir -->
    <div class="modal-overlay" id="delete-confirm-modal">
        <div class="modal-content confirmation">
             <h2>Confirmar Exclusão</h2>
             <p>Tem certeza que deseja excluir o ativo "<strong id="asset-name-to-delete"></strong>"?</p>
             <input type="hidden" id="delete-id-target">
             <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="fecharModais()">Cancelar</button>
                    <button type="button" class="btn-confirm-delete" onclick="confirmarExclusao()">Excluir</button>
                </div>
        </div>
    </div>

    <!-- Script original para menu e outras funções visuais -->
    <script src="js/script.js"></script>

    <!-- SCRIPT DE CONTROLE DOS ATIVOS (Front + Back) -->
    <script>
        // Variável Global para guardar os dados recebidos e facilitar a edição
        let listaGlobalAtivos = [];

        // URL da API Python
        const API_BASE = 'http://127.0.0.1:5000/api/ativos'; 

        // --- 1. FUNÇÕES DE LEITURA (GET) ---
        function carregarDadosInventario() {
            const tbody = document.getElementById('inventory-table-body');
            const btn = document.getElementById('refresh-btn');
            
            if(btn) btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ...';
            
            fetch(API_BASE)
                .then(response => response.json())
                .then(data => {
                    listaGlobalAtivos = data; // Salva na memória para usar na edição
                    preencherTabela(data);
                })
                .catch(error => {
                    console.error('Erro:', error);
                    tbody.innerHTML = '<tr><td colspan="6" style="color:red; text-align:center">Erro na conexão com Python.</td></tr>';
                })
                .finally(() => {
                    if(btn) btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Atualizar';
                });
        }

        function preencherTabela(dados) {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = ''; 

            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Nenhum ativo encontrado.</td></tr>';
                return;
            }

            dados.forEach(ativo => {
                const tr = document.createElement('tr');
                const cor = ativo.status === 'Online' ? 'green' : 'red';
                
                // AQUI ESTÁ O PULO DO GATO: Adicionei onclick direto nos botões
                tr.innerHTML = `
                    <td>${ativo.nome}</td>
                    <td>${ativo.mac_address || '-'}</td>
                    <td>${ativo.ip_address || '-'}</td>
                    <td style="color: ${cor}; font-weight: bold;">${ativo.status}</td>
                    <td>${ativo.condicao || '-'}</td>
                    <td>
                        <button class="btn-editar" onclick="prepararEdicao(${ativo.id})">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn-excluir" onclick="prepararExclusao(${ativo.id}, '${ativo.nome}')">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 2. FUNÇÕES DE MODAIS E EDIÇÃO ---

        // Abre o modal vazio para criar novo
        function abrirModalCriacao() {
            document.getElementById('modal-title').innerText = "Adicionar Novo Ativo";
            document.getElementById('assetIdDatabase').value = ""; // ID vazio = Novo
            document.getElementById('asset-form').reset();
            
            // Mostra o modal (adiciona a classe 'active' que costuma ser usada em modais, ou display flex)
            const modal = document.getElementById('asset-modal');
            modal.style.display = 'flex'; 
        }

        // Abre o modal preenchido para editar
        function prepararEdicao(id) {
            // Busca o ativo na lista que guardamos na memória
            const ativo = listaGlobalAtivos.find(a => a.id === id);
            if (!ativo) return;

            document.getElementById('modal-title').innerText = "Editar Ativo";
            document.getElementById('assetIdDatabase').value = ativo.id; // ID preenchido = Edição
            
            // Preenche os campos
            document.getElementById('assetName').value = ativo.nome;
            document.getElementById('macAddress').value = ativo.mac_address;
            document.getElementById('assetId').value = ativo.ip_address;
            document.getElementById('assetStatus').value = ativo.status;
            document.getElementById('assetCondition').value = ativo.condicao;

            document.getElementById('asset-modal').style.display = 'flex';
        }

        // Abre o modal de confirmação de exclusão
        function prepararExclusao(id, nome) {
            document.getElementById('asset-name-to-delete').innerText = nome;
            document.getElementById('delete-id-target').value = id;
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        function fecharModais() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        }

        // --- 3. FUNÇÕES DE GRAVAÇÃO (POST/PUT/DELETE) ---

        // Salvar (Criar ou Editar)
        function salvarAtivo(event) {
            event.preventDefault(); // Não recarrega a página
            
            const id = document.getElementById('assetIdDatabase').value;
            const dados = {
                nome: document.getElementById('assetName').value,
                mac_address: document.getElementById('macAddress').value,
                ip_address: document.getElementById('assetId').value,
                status: document.getElementById('assetStatus').value,
                condicao: document.getElementById('assetCondition').value
            };

            let url = API_BASE;
            let metodo = 'POST';

            // Se tem ID, é edição (PUT)
            if (id) {
                url = `${API_BASE}/${id}`;
                metodo = 'PUT';
            }

            fetch(url, {
                method: metodo,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dados)
            })
            .then(res => res.json())
            .then(() => {
                fecharModais();
                carregarDadosInventario(); // Atualiza a tabela
                alert(id ? 'Ativo atualizado!' : 'Ativo criado!');
            })
            .catch(err => alert('Erro ao salvar: ' + err));
        }

        // Excluir
        function confirmarExclusao() {
            const id = document.getElementById('delete-id-target').value;
            
            fetch(`${API_BASE}/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(() => {
                fecharModais();
                carregarDadosInventario(); // Atualiza a tabela
                alert('Ativo excluído!');
            })
            .catch(err => alert('Erro ao excluir: ' + err));
        }

        // Inicializa ao carregar a página
        document.addEventListener('DOMContentLoaded', carregarDadosInventario);
    </script>
</body>
</html>